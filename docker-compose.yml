services:
  srs:
    image: ossrs/srs:5
    container_name: srs-streaming-server
    expose:
      - "8080"
    ports:
      - "1935:1935"   # RTMP Port
      - "1985:1985"   # HTTP API Port
    volumes:
      - ./srs:/usr/local/srs/conf
      - ./html:/usr/local/srs/objs/nginx/html
    command: ["./objs/srs", "-c", "conf/srs.conf"]
    restart: unless-stopped
    environment:
      - CANDIDATE=0.0.0.0
    networks:
      - default
    labels:
      - "traefik.http.services.srs.loadbalancer.server.port=8080"

  nginx:
    image: nginx:alpine
    container_name: nginx-webserver
    expose:
      - "80"
    volumes:
      - ./html:/var/www/html
      - ./nginx:/etc/nginx/conf.d
    depends_on:
      - php-fpm
    restart: unless-stopped
    networks:
      - default
    labels:
      - "traefik.http.services.nginx-php.loadbalancer.server.port=80"

  php-fpm:
    image: php:7.4-fpm-alpine
    container_name: php-fpm-server
    volumes:
      - ./html:/var/www/html
    restart: unless-stopped
    networks:
      - default

  webrtc-signaling:
    image: node:18-alpine
    container_name: webrtc-signaling-server
    working_dir: /app
    expose:
      - "3000"
    volumes:
      - ./signaling-server:/app
      - ./html/videos:/videos:ro
    command: sh -c "apk add --no-cache ffmpeg && npm install && npm start"
    restart: unless-stopped
    networks:
      - default
    labels:
      - "traefik.http.services.webrtc-signaling.loadbalancer.server.port=3000"

  auto-hls:
    image: jrottenberg/ffmpeg:4.4-alpine
    container_name: auto-hls-streams
    volumes:
      - ./html/videos:/videos:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "üé¨ Starting HLS streams..."
        sleep 5
        start_stream() {
            FILE="$$1"
            ROOM="$$2"
            echo "‚ñ∂Ô∏è  Starting: $$ROOM ($$FILE)"
            ffmpeg -re -stream_loop -1 -i "/videos/$$FILE" \
                -c:v libx264 -preset veryfast -tune zerolatency -profile:v baseline -level 3.0 \
                -c:a aac -ar 44100 -b:a 128k \
                -f flv "rtmp://srs:1935/live/$$ROOM" > /dev/null 2>&1 &
            echo "   PID: $$!"
        }
        start_stream "ttr.m4v" "demo_video_stream"
        start_stream "Horrible-Boss.m4v" "demo_horrible_boss_stream"
        # start_stream "Subway.m4v" "demo_subway_stream"
        # start_stream "Chuck.und.Larry.m4v" "demo_chuck_stream"
        start_stream "StingrayIntro.mp4" "demo_stingray_stream"
        echo "‚úÖ All HLS streams started"
        ps | grep ffmpeg | grep -v grep
        echo "‚è≥ Keeping container alive..."
        wait
        while true; do sleep 3600; done
    restart: unless-stopped
    depends_on:
      - srs
    networks:
      - default
